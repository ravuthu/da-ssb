name: Sync aem.js from Source

on:
  repository_dispatch:
    types: [sync-aem-js]
  workflow_dispatch:

jobs:
  sync-aem-js:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download latest aem.js from source (authenticated)
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          # Use GitHub API with authentication for private repos
          curl -sSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/ravuthu/da-ue-test/contents/scripts/aem.js?ref=main" \
            -o scripts/aem.js
          
          echo "Downloaded aem.js successfully"
          head -5 scripts/aem.js
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet scripts/aem.js; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in aem.js"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in aem.js:"
            git diff --stat scripts/aem.js
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: sync aem.js from ravuthu/da-ue-test"
          title: "ðŸ”„ Sync aem.js from da-ue-test"
          body: |
            This PR automatically syncs `scripts/aem.js` from the source repository.
            
            **Source:** https://github.com/ravuthu/da-ue-test/blob/main/scripts/aem.js
            
            ---
            _This PR was created automatically._
          branch: chore/sync-aem-js
          delete-branch: true
